<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel â€“ M. Rajesh</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:'Montserrat',sans-serif;background:#111;color:white;}
.header{background:#000;padding:15px 30px;display:flex;justify-content:space-between;align-items:center;}
.header h2{color:#ff8c00;margin:0;}
.logout-btn{background:#ff8c00;border:none;padding:8px 15px;color:white;border-radius:5px;cursor:pointer;}
.container{padding:40px;}
.section-box{background:#1a1a1a;padding:20px;border-radius:10px;margin-top:30px;box-shadow:0 0 20px rgba(255,140,0,0.2);}
input,select{padding:8px;margin:5px;border-radius:5px;border:none;}
button{background:#ff8c00;border:none;padding:8px 12px;color:white;border-radius:5px;cursor:pointer;margin-top:5px;}
h3{color:#ff8c00;margin-top:0;}
table{width:100%;margin-top:15px;border-collapse:collapse;}
th,td{padding:8px;border:1px solid #333;text-align:center;}
.download-btn{margin-top:15px;background:#00b894;}
</style>
</head>

<body>

<div class="header">
<h2>Admin Panel â€“ M. Rajesh (Managing Director)</h2>
<button class="logout-btn" onclick="logoutUser()">Logout</button>
</div>

<div class="container">

<!-- ATTENDANCE CONTROL -->
<div class="section-box">
<h3>Attendance Closing Time</h3>
<input type="number" id="closeHourInput" min="0" max="23" placeholder="Hour">
:
<input type="number" id="closeMinuteInput" min="0" max="59" placeholder="Minute">
<br>
<button onclick="updateCloseTime()">Update Closing Time</button>
<p id="timeStatus"></p>
</div>

<!-- MONTHLY ATTENDANCE VIEW -->
<div class="section-box">
<h3>Monthly Attendance Report</h3>
<input type="month" id="monthPicker">
<button onclick="generateMonthlyReport()">Generate Report</button>
<div id="monthlyReport" style="margin-top:15px;"></div>
</div>

<!-- ADVANCED ATTENDANCE DOWNLOAD -->
<div class="section-box">
<h3>Download Attendance Reports</h3>

<select id="reportType">
<option value="monthly">Monthly</option>
<option value="range">Date Range</option>
</select>

<div id="monthlySection">
<input type="month" id="downloadMonth">
</div>

<div id="rangeSection" style="display:none;">
<input type="date" id="fromDate">
<input type="date" id="toDate">
</div>

<select id="employeeSelect"></select>
<br>
<button class="download-btn" onclick="downloadAttendanceReport()">
ðŸ“¥ Download Detailed Attendance
</button>
</div>

<!-- ERP CUSTOMER MANAGEMENT -->
<div class="section-box">
<h3>Customer ERP Management</h3>

<table>
<thead>
<tr>
<th>Customer</th>
<th>Executive</th>
<th>Total</th>
<th>Paid</th>
<th>Balance</th>
<th>Status</th>
</tr>
</thead>
<tbody id="customerTable"></tbody>
</table>

<button class="download-btn" onclick="downloadPendingCustomers()">
ðŸ“¥ Download Pending Customers
</button>

</div>

</div>

<script type="module">
import { checkSession } from "./auth.js";
checkSession("admin");
</script>

<script type="module">
import { db } from "./firebase-config.js";
import { collection, getDocs, doc, getDoc, setDoc, updateDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ==============================
   LOAD EMPLOYEES FOR DROPDOWN
============================== */
async function loadEmployees(){
const usersSnapshot=await getDocs(collection(db,"users"));
const select=document.getElementById("employeeSelect");
select.innerHTML="";
usersSnapshot.forEach(userDoc=>{
const user=userDoc.data();
if(user.role==="employee"){
select.innerHTML+=`<option value="${userDoc.id}">${user.name}</option>`;
}
});
}
loadEmployees();

/* ==============================
   TOGGLE REPORT TYPE
============================== */
document.getElementById("reportType").addEventListener("change",(e)=>{
if(e.target.value==="monthly"){
document.getElementById("monthlySection").style.display="block";
document.getElementById("rangeSection").style.display="none";
}else{
document.getElementById("monthlySection").style.display="none";
document.getElementById("rangeSection").style.display="block";
}
});

/* ==============================
   DOWNLOAD ATTENDANCE
============================== */
window.downloadAttendanceReport=async function(){

const type=document.getElementById("reportType").value;
const employeeId=document.getElementById("employeeSelect").value;

if(!employeeId){alert("Select employee");return;}

let fromDate,toDate;

if(type==="monthly"){
const month=document.getElementById("downloadMonth").value;
if(!month){alert("Select month");return;}
const [year,mon]=month.split("-");
fromDate=`${year}-${mon}-01`;
toDate=new Date(year,mon,0).toISOString().split("T")[0];
}else{
fromDate=document.getElementById("fromDate").value;
toDate=document.getElementById("toDate").value;
if(!fromDate||!toDate){alert("Select dates");return;}
}

const attendanceSnapshot=await getDocs(collection(db,"attendance"));
const usersSnapshot=await getDocs(collection(db,"users"));
const userDoc=usersSnapshot.docs.find(doc=>doc.id===employeeId);
const employeeName=userDoc?.data().name||"Employee";

let current=new Date(fromDate);
const end=new Date(toDate);

let csv=`Employee Name: ${employeeName}\n`;
csv+=`Report Period: ${fromDate} to ${toDate}\n\n`;
csv+="Date,Status\n";

while(current<=end){
const dateStr=current.toISOString().split("T")[0];
const day=current.getDay();
if(day!==0){ // Ignore Sundays
let present=false;
attendanceSnapshot.forEach(doc=>{
const data=doc.data();
if(data.employeeId===employeeId && data.date===dateStr){
present=true;
}
});
csv+=`${dateStr},${present?"Present":"Absent"}\n`;
}
current.setDate(current.getDate()+1);
}

const encodedUri=encodeURI("data:text/csv;charset=utf-8,"+csv);
const link=document.createElement("a");
link.setAttribute("href",encodedUri);
link.setAttribute("download","Attendance_Detailed_Report.csv");
document.body.appendChild(link);
link.click();
};

/* ==============================
   CUSTOMER ERP SECTION
============================== */
async function loadCustomers(){
const snapshot=await getDocs(collection(db,"customerPayments"));
const table=document.getElementById("customerTable");
table.innerHTML="";
snapshot.forEach(docSnap=>{
const data=docSnap.data();
const payments=data.payments||[];
const totalPaid=payments.reduce((sum,p)=>sum+p.amount,0);
const balance=data.totalAmount-totalPaid;
table.innerHTML+=`
<tr>
<td>${data.customerName}</td>
<td>${data.executiveName}</td>
<td>â‚¹${data.totalAmount}</td>
<td>â‚¹${totalPaid}</td>
<td style="color:${balance===0?'#00e676':'#ff5252'}">â‚¹${balance}</td>
<td>${balance===0?'Completed':'Pending'}</td>
</tr>`;
});
}
loadCustomers();

window.downloadPendingCustomers=async function(){
const snapshot=await getDocs(collection(db,"customerPayments"));
let csv="Customer Name,Executive,Total Amount,Paid,Balance,Status\n";
snapshot.forEach(docSnap=>{
const data=docSnap.data();
const payments=data.payments||[];
const totalPaid=payments.reduce((sum,p)=>sum+p.amount,0);
const balance=data.totalAmount-totalPaid;
if(balance>0){
csv+=`${data.customerName},${data.executiveName},${data.totalAmount},${totalPaid},${balance},Pending\n`;
}
});
const encodedUri=encodeURI("data:text/csv;charset=utf-8,"+csv);
const link=document.createElement("a");
link.setAttribute("href",encodedUri);
link.setAttribute("download","Pending_Customers_Report.csv");
document.body.appendChild(link);
link.click();
};

/* ==============================
   ATTENDANCE SETTINGS
============================== */
async function loadClosingTime(){
const snap=await getDoc(doc(db,"settings","attendance"));
if(snap.exists()){
const data=snap.data();
document.getElementById("closeHourInput").value=data.closeHour??11;
document.getElementById("closeMinuteInput").value=data.closeMinute??0;
}
}
loadClosingTime();

window.updateCloseTime=async function(){
const hour=parseInt(document.getElementById("closeHourInput").value);
const minute=parseInt(document.getElementById("closeMinuteInput").value);
if(isNaN(hour)||hour<0||hour>23||isNaN(minute)||minute<0||minute>59){
document.getElementById("timeStatus").innerText="Invalid time.";
return;
}
await setDoc(doc(db,"settings","attendance"),{closeHour:hour,closeMinute:minute},{merge:true});
document.getElementById("timeStatus").innerText="Updated successfully!";
};
</script>

<script type="module" src="auth.js"></script>

</body>
</html>
