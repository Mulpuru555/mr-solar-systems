<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel â€“ M.R Solar Systems</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:'Montserrat',sans-serif;background:#111;color:white;display:flex;height:100vh;}
.sidebar{width:240px;background:#000;padding:20px;display:flex;flex-direction:column;}
.sidebar h3{color:#ff8c00;margin-bottom:30px;}
.sidebar button{background:none;border:none;color:white;text-align:left;padding:12px;margin-bottom:8px;cursor:pointer;border-radius:6px;font-size:14px;}
.sidebar button:hover{background:#1a1a1a;}
.main{flex:1;padding:30px;overflow:auto;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.logout-btn{background:#ff8c00;border:none;padding:8px 15px;color:white;border-radius:6px;cursor:pointer;}

.summary-container{display:flex;gap:20px;margin-bottom:30px;flex-wrap:wrap;}
.summary-card{flex:1;min-width:220px;padding:25px;border-radius:15px;text-align:center;}
.revenue-card{background:linear-gradient(135deg,#00b894,#00cec9);}
.pending-card{background:linear-gradient(135deg,#d63031,#e17055);}
.present-card{background:linear-gradient(135deg,#6c5ce7,#a29bfe);}

.section-box{background:#1a1a1a;padding:25px;border-radius:12px;margin-top:20px;}

input,select{padding:8px 10px;margin:5px;border-radius:6px;border:none;}
button.action{background:#ff8c00;border:none;padding:8px 14px;color:white;border-radius:6px;cursor:pointer;}

table{width:100%;margin-top:15px;border-collapse:collapse;background:#151515;}
th{background:#222;color:#ff8c00;}
th,td{padding:12px;border-bottom:1px solid #2c2c2c;text-align:center;}

.lock-btn{background:#d63031;}
.unlock-btn{background:#00cec9;}
.pay-btn{background:#0984e3;}
.serial{color:#ff8c00;font-weight:600;}

.section{display:none;}
.section.active{display:block;}
</style>
</head>

<body>

<div class="sidebar">
<h3>M.R Solar Admin</h3>
<button onclick="showSection('overview')">ðŸ“Š Overview</button>
<button onclick="showSection('attendanceControl')">ðŸ•’ Attendance Control</button>
<button onclick="showSection('attendanceReport')">ðŸ“ˆ Attendance Report</button>
<button onclick="showSection('holidayManagement')">ðŸŽ‰ Holiday Management</button>
<button onclick="showSection('erp')">ðŸ’° Customer ERP</button>
</div>

<div class="main">

<div class="header">
<h2>Admin Panel â€“ M. Rajesh</h2>
<button class="logout-btn" onclick="logoutUser()">Logout</button>
</div>

<!-- OVERVIEW -->
<div id="overview" class="section active">
<div class="summary-container">
<div class="summary-card revenue-card">
<h4>Total Revenue</h4>
<h2 id="totalRevenue">â‚¹ 0</h2>
</div>
<div class="summary-card pending-card">
<h4>Total Pending</h4>
<h2 id="totalPending">â‚¹ 0</h2>
</div>
<div class="summary-card present-card">
<h4>Today Present</h4>
<h2 id="todayPresent">0</h2>
</div>
</div>
</div>

<!-- ATTENDANCE CONTROL -->
<div id="attendanceControl" class="section">
<div class="section-box">
<h3>Attendance Closing Time</h3>
<input type="number" id="closeHourInput" min="0" max="23" placeholder="Hour">
:
<input type="number" id="closeMinuteInput" min="0" max="59" placeholder="Minute">
<br>
<button class="action" onclick="updateCloseTime()">Update Closing Time</button>
<p id="timeStatus"></p>
</div>
</div>

<!-- ATTENDANCE REPORT -->
<div id="attendanceReport" class="section">
<div class="section-box">
<h3>Employee Attendance Report</h3>
<input type="month" id="reportMonth">
<button class="action" onclick="generateAttendanceReport()">Generate</button>
<div id="attendanceReportData"></div>
</div>
</div>

<!-- ERP -->
<div id="erp" class="section">
<div class="section-box">
<h3>Customer ERP Management (Live)</h3>

<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
<input type="text" id="searchInput" placeholder="Search Customer / Executive">
<label><input type="checkbox" id="pendingOnly"> Show Pending Only</label>
<button class="action" onclick="exportFullReport()">Export CSV</button>
</div>

<table>
<thead>
<tr>
<th>S.No</th>
<th>Customer</th>
<th>Executive</th>
<th>Total</th>
<th>Paid</th>
<th>Balance</th>
<th>Status</th>
<th>Work Status</th>
<th>Payment</th>
<th>Lock</th>
</tr>
</thead>
<tbody id="customerTable"></tbody>
</table>

</div>
</div>

</div>
  
<!-- HOLIDAY MANAGEMENT -->
<div id="holidayManagement" class="section">
<div class="section-box">
<h3>Holiday Management</h3>

<input type="date" id="holidayDate">
<input type="text" id="holidayName" placeholder="Holiday Name">
<button class="action" onclick="addHoliday()">Add Holiday</button>

<div id="holidayMessage" style="margin-top:10px;"></div>

<table>
<thead>
<tr>
<th>Date</th>
<th>Name</th>
<th>Action</th>
</tr>
</thead>
<tbody id="holidayTable"></tbody>
</table>

</div>
</div>
<script type="module">
import { checkSession } from "./auth.js";
checkSession("admin");
</script>

<script type="module">
import { deleteDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { db } from "./firebase-config.js";
import { collection, getDoc, doc, setDoc, updateDoc, getDocs, onSnapshot } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

window.showSection=function(id){
document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active'));
document.getElementById(id).classList.add('active');
};

const table=document.getElementById("customerTable");
const searchInput=document.getElementById("searchInput");
const pendingCheckbox=document.getElementById("pendingOnly");
searchInput.addEventListener("input", renderDashboard);
pendingCheckbox.addEventListener("change", renderDashboard);

let allDocs=[];

onSnapshot(collection(db,"customerPayments"),(snapshot)=>{
allDocs=[];
snapshot.forEach(docSnap=>{
allDocs.push({id:docSnap.id,...docSnap.data()});
});
renderDashboard();
});

onSnapshot(collection(db,"attendance"),(snapshot)=>{
let today=new Date().toISOString().split("T")[0];
let count=0;
snapshot.forEach(docSnap=>{
if(docSnap.data().date===today) count++;
});
document.getElementById("todayPresent").innerText=count;
});

function renderDashboard(){
let totalRevenue=0;
let totalPending=0;
table.innerHTML="";

let searchText=searchInput.value.toLowerCase();
let pendingOnly=pendingCheckbox.checked;

let sortedDocs=[...allDocs].sort((a,b)=>{
const A=a.createdAt?.seconds||0;
const B=b.createdAt?.seconds||0;
return B-A;
});

let serial=1;

sortedDocs.forEach(data=>{
const payments=data.payments||[];
const totalPaid=payments.reduce((sum,p)=>sum+p.amount,0);
const balance=data.totalAmount-totalPaid;
const status=balance===0?"Completed":"Pending";
const workStatus=data.workStatus||"Not Completed";

if(searchText){
if(!data.customerName?.toLowerCase().includes(searchText)&&
!data.executiveName?.toLowerCase().includes(searchText)) return;
}
if(pendingOnly&&balance===0) return;

totalRevenue+=totalPaid;
totalPending+=balance;

table.innerHTML+=`
<tr>
<td class="serial">${serial++}</td>
<td>${data.customerName}</td>
<td>${data.executiveName}</td>
<td>â‚¹${data.totalAmount}</td>
<td>â‚¹${totalPaid}</td>
<td style="color:${balance===0?'#00e676':'#ff5252'}">â‚¹${balance}</td>
<td>${status}</td>
<td>
<select onchange="updateWorkStatus('${data.id}', this.value)">
<option value="Not Completed" ${workStatus==="Not Completed"?"selected":""}>Not Completed</option>
<option value="Completed" ${workStatus==="Completed"?"selected":""}>Completed</option>
</select>
</td>
<td><button class="pay-btn" onclick="addPayment('${data.id}')">Add</button></td>
<td>
<button class="${data.isLocked?'unlock-btn':'lock-btn'}"
onclick="toggleLock('${data.id}',${data.isLocked})">
${data.isLocked?'Unlock':'Lock'}
</button>
</td>
</tr>`;
});

document.getElementById("totalRevenue").innerText="â‚¹ "+totalRevenue.toLocaleString();
document.getElementById("totalPending").innerText="â‚¹ "+totalPending.toLocaleString();
}

window.addPayment = async function(id){

const confirmAction = confirm("Are you sure you want to add payment?");
if(!confirmAction) return;

const amount = prompt("Enter Payment Amount:");
if(!amount || isNaN(amount)){
alert("Invalid amount.");
return;
}

try{

const snap = await getDoc(doc(db,"customerPayments",id));
const data = snap.data();

const payments = data.payments || [];

payments.push({
amount: Number(amount),
date: new Date().toISOString().split("T")[0]
});

await updateDoc(doc(db,"customerPayments",id),{
payments: payments
});

alert("Payment added successfully.");

}catch(error){
console.error(error);
alert("Failed to add payment.");
}

};

window.toggleLock = async function(id,state){

const action = state ? "Unlock" : "Lock";
const confirmAction = confirm(`Are you sure you want to ${action} this record?`);
if(!confirmAction) return;

try{
await updateDoc(doc(db,"customerPayments",id),{
isLocked: !state
});
alert("Updated successfully.");
}catch(error){
console.error(error);
alert("Failed to update lock status.");
}

};

window.updateWorkStatus=async function(id,value){
await updateDoc(doc(db,"customerPayments",id),{workStatus:value});
};

window.exportFullReport=async function(){
const snapshot=await getDocs(collection(db,"customerPayments"));
let csv="Customer,Executive,Total,Paid,Balance\n";
snapshot.forEach(docSnap=>{
const data=docSnap.data();
const payments=data.payments||[];
const totalPaid=payments.reduce((sum,p)=>sum+p.amount,0);
const balance=data.totalAmount-totalPaid;
csv+=`${data.customerName},${data.executiveName},${data.totalAmount},${totalPaid},${balance}\n`;
});
const blob=new Blob([csv],{type:"text/csv"});
const link=document.createElement("a");
link.href=URL.createObjectURL(blob);
link.download="Full_Report.csv";
link.click();
};

async function loadClosingTime(){
const snap=await getDoc(doc(db,"settings","attendance"));
if(snap.exists()){
document.getElementById("closeHourInput").value=snap.data().closeHour??11;
document.getElementById("closeMinuteInput").value=snap.data().closeMinute??0;
}
}
loadClosingTime();

window.updateCloseTime=async function(){
const hour=parseInt(document.getElementById("closeHourInput").value);
const minute=parseInt(document.getElementById("closeMinuteInput").value);
if(isNaN(hour)||hour<0||hour>23||isNaN(minute)||minute<0||minute>59){
document.getElementById("timeStatus").innerText="Invalid time.";
return;
}
await setDoc(doc(db,"settings","attendance"),
{closeHour:hour,closeMinute:minute},{merge:true});
document.getElementById("timeStatus").innerText="Updated successfully!";
};
window.generateAttendanceReport = async function(){

let month = document.getElementById("reportMonth").value;
if(!month){
alert("Please select month.");
return;
}

const attendanceSnap = await getDocs(collection(db,"attendance"));
const usersSnap = await getDocs(collection(db,"users"));

let userMap = {};
usersSnap.forEach(docSnap=>{
userMap[docSnap.id] = docSnap.data().name || "Unknown";
});

let reportMap = {};

attendanceSnap.forEach(docSnap=>{
let data = docSnap.data();
if(data.date?.startsWith(month)){
if(!reportMap[data.employeeId]) reportMap[data.employeeId] = 0;
reportMap[data.employeeId]++;
}
});

let html = "<table><tr><th>Employee Name</th><th>Present Days</th></tr>";

for(let empId in reportMap){
let empName = userMap[empId] || "Unknown";
html += `<tr>
<td>${empName}</td>
<td>${reportMap[empId]}</td>
</tr>`;
}

html += "</table>";

document.getElementById("attendanceReportData").innerHTML = html;

};
/* =========================
   HOLIDAY MANAGEMENT
========================= */

const holidayTable = document.getElementById("holidayTable");

async function loadHolidays(){

  holidayTable.innerHTML = "";

  const snapshot = await getDocs(
    collection(db,"settings","holidays","holidayList")
  );

  snapshot.forEach(docSnap=>{

    const data = docSnap.data();

    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${data.date}</td>
      <td>${data.name}</td>
      <td>
        <button class="lock-btn"
          onclick="deleteHoliday('${docSnap.id}')">
          Delete
        </button>
      </td>
    `;

    holidayTable.appendChild(row);
  });
}

window.addHoliday = async function(){

  const date = document.getElementById("holidayDate").value;
  const name = document.getElementById("holidayName").value.trim();

  if(!date || !name){
    document.getElementById("holidayMessage").innerText = "Fill all fields.";
    return;
  }

  await setDoc(
    doc(db,"settings","holidays","holidayList",date),
    {
      name: name,
      date: date
    }
  );

  document.getElementById("holidayMessage").innerText = "Holiday Added Successfully.";
  document.getElementById("holidayDate").value="";
  document.getElementById("holidayName").value="";

  loadHolidays();
};

window.deleteHoliday = async function(date){

  if(!confirm("Delete this holiday?")) return;

  await deleteDoc(
    doc(db,"settings","holidays","holidayList",date)
  );

  loadHolidays();
};

loadHolidays();
</script>

<script type="module" src="auth.js"></script>

</body>
</html>
