<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Employee Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:'Montserrat',sans-serif;background:#111;color:white;}
.header{background:#000;padding:15px 30px;display:flex;justify-content:space-between;}
.header h2{color:#ff8c00;}
.logout-btn{background:#ff8c00;border:none;padding:8px 15px;color:white;border-radius:5px;}
.dashboard-container{padding:40px;text-align:center;}
.attendance-box{background:#1a1a1a;padding:30px;border-radius:10px;margin-top:30px;}
.attendance-btn{margin-top:20px;padding:12px 25px;background:linear-gradient(45deg,#ff8c00,#ff5e00);border:none;color:white;border-radius:6px;cursor:pointer;}
.attendance-btn:disabled{background:gray;cursor:not-allowed;}
.status-message{margin-top:15px;}
.distance-box{margin-top:15px;font-weight:bold;}
.green{color:#00e676;}
.red{color:#ff5252;}
.payment-box{background:#1a1a1a;padding:30px;border-radius:10px;margin-top:40px;}
.payment-box input{padding:10px;width:250px;border-radius:5px;border:none;margin-bottom:10px;}
.payment-btn{margin-top:10px;padding:12px 25px;background:linear-gradient(45deg,#ff8c00,#ff5e00);border:none;color:white;border-radius:6px;cursor:pointer;}
</style>
</head>

<body>

<div class="header">
<h2>M.R Solar Systems Employee Portal</h2>
<button class="logout-btn" onclick="logoutUser()">Logout</button>
</div>

<div class="dashboard-container">
<h1>Attendance</h1>

<div class="attendance-box">

<div id="distanceDisplay" class="distance-box">Checking location...</div>

<div id="countdownBox" style="margin-bottom:15px;font-weight:600;">
üïí Loading countdown...
</div>

<button id="attendanceBtn" class="attendance-btn" onclick="markAttendance()">
Mark Attendance
</button>

<div id="attendanceStatus" class="status-message"></div>

</div>

<!-- ================= PAYMENT SECTION ================= -->

<div class="payment-box">
<h1>Add Customer Payment</h1>

<form id="paymentForm">
<input type="text" id="customerName" placeholder="Customer Name" required><br>
<input type="text" id="executiveName" placeholder="Executive Name" required><br>
<input type="number" id="sanctionedAmount" placeholder="Sanctioned Amount" required><br>
<button type="submit" class="payment-btn">Submit</button>
</form>

<div id="paymentMessage" class="status-message"></div>
</div>
<hr style="margin:40px 0;">

<h1>My Customers</h1>

<table style="width:100%; margin-top:20px; border-collapse:collapse;" border="1">
<thead>
<tr>
<th>Customer</th>
<th>Executive</th>
<th>Sanctioned</th>
<th>Paid</th>
<th>Action</th>
</tr>
</thead>
<tbody id="recordsTable"></tbody>
</table>
</div>

<!-- Protect Page -->
<script type="module">
import { checkSession } from "./auth.js";
checkSession("employee");
</script>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { addDoc, collection, serverTimestamp, query, where, getDocs, getDoc, doc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* ===== OFFICE LOCATION ===== */
const officeLat = 16.236719;
const officeLon = 80.647476;
const allowedRadius = 200;

const btn = document.getElementById("attendanceBtn");
const status = document.getElementById("attendanceStatus");
const distanceDisplay = document.getElementById("distanceDisplay");

/* ===== GET CLOSING TIME ===== */
async function getClosingTime(){
  const snap = await getDoc(doc(db,"settings","attendance"));
  if(snap.exists()){
    return {
      hour: snap.data().closeHour ?? 11,
      minute: snap.data().closeMinute ?? 0
    };
  }
  return { hour:11, minute:0 };
}

/* ===== COUNTDOWN TIMER ===== */
async function startCountdown(){
  const { hour, minute } = await getClosingTime();
  const countdownBox = document.getElementById("countdownBox");

  function updateTimer(){
    const now = new Date();
    const closingTime = new Date();
    closingTime.setHours(hour, minute, 0, 0);

    const diff = closingTime - now;

    if(diff <= 0){
      countdownBox.innerHTML = "‚ùå Attendance Closed";
      btn.disabled = true;
      return;
    }

    const hours = Math.floor(diff / (1000*60*60));
    const minutes = Math.floor((diff % (1000*60*60)) / (1000*60));
    const seconds = Math.floor((diff % (1000*60)) / 1000);

    countdownBox.innerHTML =
    `üïí Attendance closes at ${hour}:${minute.toString().padStart(2,"0")} <br>
     <span style="color:#ff8c00;">
     ${hours}h : ${minutes}m : ${seconds}s
     </span>`;
  }

  updateTimer();
  setInterval(updateTimer,1000);
}

startCountdown();

/* ===== DISTANCE FUNCTION ===== */
function getDistance(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a =
    Math.sin(dLat/2)*Math.sin(dLat/2)+
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

/* ===== LOCATION CHECK ===== */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(position=>{
    const userLat = position.coords.latitude;
    const userLon = position.coords.longitude;
    const distance = Math.round(getDistance(userLat,userLon,officeLat,officeLon));

    if(distance <= allowedRadius){
      distanceDisplay.innerHTML =
      `üìç Your distance from office: <span class="green">${distance} meters</span>`;
    }else{
      distanceDisplay.innerHTML =
      `üìç Your distance from office: <span class="red">${distance} meters</span>`;
    }
  });
}

/* ===== MARK ATTENDANCE ===== */
window.markAttendance = async function(){
  const { hour, minute } = await getClosingTime();
  const now = new Date();
  const closingTime = new Date();
  closingTime.setHours(hour, minute, 0, 0);

  if(now >= closingTime){
    status.innerText =
    `‚ùå Attendance closed after ${hour}:${minute.toString().padStart(2,"0")}`;
    return;
  }

  navigator.geolocation.getCurrentPosition(async position => {
    const userLat = position.coords.latitude;
    const userLon = position.coords.longitude;
    const distance = getDistance(userLat,userLon,officeLat,officeLon);

    if(distance > allowedRadius){
      status.innerText="‚ùå You are not inside office location.";
      return;
    }

    onAuthStateChanged(auth, async(user)=>{
      if(!user) return;

      const today=new Date().toISOString().split("T")[0];

      const q=query(collection(db,"attendance"),
        where("employeeId","==",user.uid),
        where("date","==",today)
      );

      const snapshot=await getDocs(q);

      if(!snapshot.empty){
        status.innerText="‚ö† Attendance already marked.";
        btn.disabled=true;
        return;
      }

      await addDoc(collection(db,"attendance"),{
        employeeId:user.uid,
        date:today,
        timestamp:serverTimestamp()
      });

      status.innerText="‚úÖ Attendance Marked Successfully.";
      btn.disabled=true;
    });

  });
};

/* ===== PAYMENT FORM LOGIC ===== */

const paymentForm = document.getElementById("paymentForm");
const paymentMessage = document.getElementById("paymentMessage");

if (paymentForm) {
  paymentForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    try{
      await addDoc(collection(db,"customerPayments"),{
        customerName: document.getElementById("customerName").value,
        executiveName: document.getElementById("executiveName").value,
        sanctionedAmount: Number(document.getElementById("sanctionedAmount").value),
        paidAmount: 0,
        createdBy: auth.currentUser.uid,
        createdAt: serverTimestamp()
      });

      paymentMessage.innerText="‚úÖ Customer Added Successfully.";
      paymentForm.reset();

    }catch(error){
      paymentMessage.innerText="‚ùå "+error.message;
    }
  });
}

</script>

<script type="module" src="auth.js"></script>

</body>
</html>
