<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Employee Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:'Montserrat',sans-serif;background:#111;color:white;}
.header{background:#000;padding:15px 30px;display:flex;justify-content:space-between;}
.header h2{color:#ff8c00;}
.logout-btn{background:#ff8c00;border:none;padding:8px 15px;color:white;border-radius:5px;}
.dashboard-container{padding:40px;text-align:center;}
.attendance-box{background:#1a1a1a;padding:30px;border-radius:10px;margin-top:30px;}
.attendance-btn{margin-top:20px;padding:12px 25px;background:linear-gradient(45deg,#ff8c00,#ff5e00);border:none;color:white;border-radius:6px;cursor:pointer;}
.attendance-btn:disabled{background:gray;cursor:not-allowed;}
.status-message{margin-top:15px;}
.distance-box{margin-top:15px;font-weight:bold;}
.payment-box{background:#1a1a1a;padding:30px;border-radius:10px;margin-top:40px;}
.payment-box input{padding:10px;width:250px;border-radius:5px;border:none;margin-bottom:10px;}
.payment-btn{margin-top:10px;padding:12px 25px;background:linear-gradient(45deg,#ff8c00,#ff5e00);border:none;color:white;border-radius:6px;cursor:pointer;}
table{color:white;}
th,td{padding:8px;}
</style>
</head>

<body>

<div class="header">
<h2>M.R Solar Systems Employee Portal</h2>
<button class="logout-btn" onclick="logoutUser()">Logout</button>
</div>

<div class="dashboard-container">
<h1>Attendance</h1>

<div class="attendance-box">
<div id="distanceDisplay">Checking location...</div>
<div id="countdownBox">Loading countdown...</div>
<button id="attendanceBtn" class="attendance-btn" onclick="markAttendance()">Mark Attendance</button>
<div id="attendanceStatus"></div>
</div>

<!-- ERP SECTION (UNCHANGED) -->
<div class="payment-box">
<h1>Add Customer (ERP)</h1>

<form id="paymentForm">
<input type="text" id="customerName" placeholder="Customer Name" required><br>
<input type="text" id="executiveName" placeholder="Executive Name" required><br>
<input type="number" id="totalAmount" placeholder="Total Amount" required><br>
<button type="submit" class="payment-btn">Submit</button>
</form>

<div id="paymentMessage"></div>
</div>

</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { addDoc, collection, serverTimestamp, doc, getDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* ===== OFFICE LOCATION ===== */
const officeLat = 16.236719;
const officeLon = 80.647476;
const allowedRadius = 200;

/* ===== GET CLOSING TIME ===== */
async function getClosingTime(){
  const snap = await getDoc(doc(db,"settings","attendance"));
  if(snap.exists()){
    return {
      hour: snap.data().closeHour ?? 11,
      minute: snap.data().closeMinute ?? 0
    };
  }
  return { hour:11, minute:0 };
}

/* ===== COUNTDOWN ===== */
async function startCountdown(){
  const { hour, minute } = await getClosingTime();
  const box = document.getElementById("countdownBox");

  function update(){
    const now = new Date();
    const close = new Date();
    close.setHours(hour, minute, 0, 0);

    const diff = close - now;

    if(diff <= 0){
      box.innerText = "❌ Attendance Closed";
      document.getElementById("attendanceBtn").disabled = true;
      return;
    }

    const h = Math.floor(diff/(1000*60*60));
    const m = Math.floor((diff%(1000*60*60))/(1000*60));
    const s = Math.floor((diff%(1000*60))/1000);

    box.innerText = `Closes at ${hour}:${minute.toString().padStart(2,"0")} | ${h}h ${m}m ${s}s`;
  }

  update();
  setInterval(update,1000);
}

window.markAttendance = async function(){

  if (!navigator.geolocation) {
    alert("Geolocation not supported by browser.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (pos) => {

      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      const distance = getDistance(lat,lon,officeLat,officeLon);

      document.getElementById("distanceDisplay").innerText =
        `Distance: ${Math.round(distance)} meters`;

      if(distance > allowedRadius){
        document.getElementById("attendanceStatus").innerText =
          "❌ You are outside office location.";
        return;
      }

      const user = auth.currentUser;
      const today = new Date().toISOString().split("T")[0];

      await addDoc(collection(db,"attendance"),{
        employeeId:user.uid,
        date:today,
        timestamp:serverTimestamp()
      });

      document.getElementById("attendanceStatus").innerText =
        "✅ Attendance Marked";
      document.getElementById("attendanceBtn").disabled=true;
    },

    (error) => {
      console.log(error);
      document.getElementById("attendanceStatus").innerText =
        "❌ Location permission denied or unavailable.";
    }
  );
};
/* ===== DISTANCE CALCULATION ===== */
function getDistance(lat1, lon1, lat2, lon2){
  const R = 6371e3;
  const φ1 = lat1 * Math.PI/180;
  const φ2 = lat2 * Math.PI/180;
  const Δφ = (lat2-lat1) * Math.PI/180;
  const Δλ = (lon2-lon1) * Math.PI/180;

  const a = Math.sin(Δφ/2)*Math.sin(Δφ/2) +
            Math.cos(φ1)*Math.cos(φ2) *
            Math.sin(Δλ/2)*Math.sin(Δλ/2);
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R*c;
}

/* START AFTER LOGIN */
onAuthStateChanged(auth,(user)=>{
  if(user){
    startCountdown();
  }
});
</script>

</body>
</html>
