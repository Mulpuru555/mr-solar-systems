<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Employee Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
margin:0;
font-family:'Montserrat',sans-serif;
background:#0f0f0f;
color:white;
}

.header{
background:#000;
padding:15px 30px;
display:flex;
justify-content:space-between;
align-items:center;
box-shadow:0 4px 10px rgba(0,0,0,0.6);
}

.header h2{
color:#ff8c00;
margin:0;
}

.logout-btn{
background:#ff8c00;
border:none;
padding:8px 15px;
color:white;
border-radius:6px;
cursor:pointer;
transition:0.3s;
}
.logout-btn:hover{
background:#ff5e00;
transform:scale(1.05);
}

.dashboard-container{
padding:40px;
max-width:1200px;
margin:auto;
}

.section-title{
margin-bottom:15px;
color:#ff8c00;
font-weight:600;
}

.attendance-box{
background:#1a1a1a;
padding:30px;
border-radius:15px;
box-shadow:0 0 20px rgba(255,140,0,0.15);
margin-bottom:40px;
text-align:center;
}

.attendance-btn{
margin-top:20px;
padding:12px 25px;
background:linear-gradient(45deg,#ff8c00,#ff5e00);
border:none;
color:white;
border-radius:8px;
cursor:pointer;
font-weight:600;
transition:0.3s;
}
.attendance-btn:hover{
transform:scale(1.05);
}
.attendance-btn:disabled{
background:gray;
cursor:not-allowed;
}

.status-message{
margin-top:15px;
font-weight:600;
}

.distance-box{
margin-top:15px;
font-weight:bold;
}

.green{color:#00e676;}
.red{color:#ff5252;}

.payment-box{
background:#1a1a1a;
padding:30px;
border-radius:15px;
box-shadow:0 0 20px rgba(255,140,0,0.15);
margin-bottom:40px;
}

.payment-box input{
padding:12px;
width:260px;
border-radius:8px;
border:none;
margin-bottom:15px;
background:#222;
color:white;
}

.payment-btn{
padding:12px 25px;
background:linear-gradient(45deg,#ff8c00,#ff5e00);
border:none;
color:white;
border-radius:8px;
cursor:pointer;
font-weight:600;
transition:0.3s;
}
.payment-btn:hover{
transform:scale(1.05);
}

table{
width:100%;
border-collapse:collapse;
margin-top:20px;
background:#1a1a1a;
border-radius:15px;
overflow:hidden;
}

th{
background:#222;
color:#ff8c00;
padding:12px;
}

td{
padding:12px;
border-bottom:1px solid #333;
text-align:center;
}

tr:hover{
background:#222;
}
</style>
</head>

<body>

<div class="header">
<h2>M.R Solar Systems Employee Portal</h2>
<button class="logout-btn" onclick="logoutUser()">Logout</button>
</div>

<div class="dashboard-container">

<h2 class="section-title">Attendance</h2>

<div class="attendance-box">
<div id="distanceDisplay" class="distance-box">Checking location...</div>
<div id="countdownBox" style="margin-bottom:15px;font-weight:600;">Loading countdown...</div>

<button id="attendanceBtn" class="attendance-btn" onclick="markAttendance()" disabled>
Mark Attendance
</button>

<div id="attendanceStatus" class="status-message"></div>
</div>

<h2 class="section-title">Add Customer (ERP)</h2>

<div class="payment-box">
<form id="paymentForm">
<input type="text" id="customerName" placeholder="Customer Name" required><br>
<input type="text" id="executiveName" placeholder="Executive Name" required><br>
<input type="number" id="totalAmount" placeholder="Total Amount" required><br>
<button type="submit" class="payment-btn">Submit</button>
</form>
<div id="paymentMessage" class="status-message"></div>
</div>

<h2 class="section-title">My Registrations</h2>

<table>
<thead>
<tr>
<th>Customer</th>
<th>Executive</th>
<th>Total</th>
<th>Paid</th>
<th>Status</th>
<th>Lock</th>
</tr>
</thead>
<tbody id="recordsTable"></tbody>
</table>

</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { addDoc, collection, serverTimestamp, query, where, getDocs, doc, getDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* ==============================
   AUTH + BLOCK CHECK
============================== */
onAuthStateChanged(auth, async (user)=>{
  if(user){

    const empSnap = await getDoc(doc(db,"employees",user.uid));

    if(empSnap.exists()){
      const empData = empSnap.data();
      if(empData.accountStatus === "blocked"){
        showBlockedScreen();
        return;
      }
    }

    startCountdown();
    startLocationTracking();
    loadRecords();

  }else{
    window.location.href="index.html";
  }
});

/* ==============================
   BLOCK SCREEN
============================== */
function showBlockedScreen(){
  document.body.innerHTML=`
  <div style="height:100vh;display:flex;justify-content:center;align-items:center;background:#0f0f0f;color:white;font-family:Montserrat;">
  <div style="background:#1a1a1a;padding:50px;border-radius:15px;border:2px solid red;text-align:center;box-shadow:0 0 25px rgba(255,0,0,0.3);">
  <h2 style="color:#ff5252;">ðŸ”’ ACCOUNT BLOCKED</h2>
  <p>Your account has been blocked due to irresponsible attendance activity.</p>
  <p>Please contact Manager to reactivate your account.</p>
  <button onclick="logoutUser()" style="margin-top:20px;padding:10px 20px;background:#ff5252;border:none;border-radius:8px;color:white;cursor:pointer;">Logout</button>
  </div>
  </div>`;
}

/* ==============================
   OFFICE LOCATION SETTINGS
============================== */
const officeLat = 16.236719;
const officeLon = 80.647476;
const allowedRadius = 200;

const btn = document.getElementById("attendanceBtn");
const statusBox = document.getElementById("attendanceStatus");
const distanceDisplay = document.getElementById("distanceDisplay");

/* ==============================
   GET CLOSING TIME
============================== */
async function getClosingTime(){
  const snap = await getDoc(doc(db,"settings","attendance"));
  if(snap.exists()){
    return {
      hour: snap.data().closeHour ?? 10,
      minute: snap.data().closeMinute ?? 0
    };
  }
  return { hour:10, minute:0 };
}

/* ==============================
   COUNTDOWN
============================== */
async function startCountdown(){
  const { hour, minute } = await getClosingTime();
  const box = document.getElementById("countdownBox");

  function update(){
    const now = new Date();
    const close = new Date();
    close.setHours(hour, minute, 0, 0);
    const diff = close - now;

    if(diff <= 0){
      box.innerText="Attendance Closed";
      btn.disabled=true;
      return;
    }

    const h=Math.floor(diff/(1000*60*60));
    const m=Math.floor((diff%(1000*60*60))/(1000*60));
    const s=Math.floor((diff%(1000*60))/1000);

    box.innerText=`Closes at ${hour}:${minute.toString().padStart(2,"0")} | ${h}h ${m}m ${s}s`;
  }

  update();
  setInterval(update,1000);
}

/* ==============================
   LOCATION TRACKING
============================== */
function startLocationTracking(){

  if(!navigator.geolocation){
    distanceDisplay.innerText="Geolocation not supported";
    distanceDisplay.className="distance-box red";
    return;
  }

  navigator.geolocation.watchPosition(

    (pos)=>{
      const lat=pos.coords.latitude;
      const lon=pos.coords.longitude;
      const distance=calculateDistance(lat,lon,officeLat,officeLon);

      distanceDisplay.innerText=`Distance from office: ${Math.round(distance)} meters`;

      if(distance<=allowedRadius){
        distanceDisplay.className="distance-box green";
        btn.disabled=false;
        statusBox.innerText="";
      }else{
        distanceDisplay.className="distance-box red";
        btn.disabled=true;
        statusBox.innerText="You are outside office location";
      }
    },

    ()=>{
      distanceDisplay.innerText="Location permission denied";
      distanceDisplay.className="distance-box red";
      btn.disabled=true;
    },

    { enableHighAccuracy:true, maximumAge:0, timeout:10000 }
  );
}

/* ==============================
   MARK ATTENDANCE
============================== */
window.markAttendance = async function(){
  const user=auth.currentUser;
  const today=new Date().toISOString().split("T")[0];

  const q=query(
    collection(db,"attendance"),
    where("employeeId","==",user.uid),
    where("date","==",today)
  );

  const snapshot=await getDocs(q);

  if(!snapshot.empty){
    statusBox.innerText="Attendance already marked today.";
    btn.disabled=true;
    return;
  }

  await addDoc(collection(db,"attendance"),{
    employeeId:user.uid,
    date:today,
    timestamp:serverTimestamp()
  });

  statusBox.innerText="Attendance Marked Successfully";
  btn.disabled=true;
};

/* ==============================
   DISTANCE FORMULA
============================== */
function calculateDistance(lat1, lon1, lat2, lon2){
  const R=6371e3;
  const Ï†1=lat1*Math.PI/180;
  const Ï†2=lat2*Math.PI/180;
  const Î”Ï†=(lat2-lat1)*Math.PI/180;
  const Î”Î»=(lon2-lon1)*Math.PI/180;

  const a=Math.sin(Î”Ï†/2)*Math.sin(Î”Ï†/2)+
          Math.cos(Ï†1)*Math.cos(Ï†2)*
          Math.sin(Î”Î»/2)*Math.sin(Î”Î»/2);

  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

/* ==============================
   ERP SAVE
============================== */
const paymentForm=document.getElementById("paymentForm");
const paymentMessage=document.getElementById("paymentMessage");
const submitBtn=paymentForm.querySelector("button");

paymentForm.addEventListener("submit", async (e)=>{
  e.preventDefault();

  paymentMessage.innerText="";
  const user=auth.currentUser;

  if(!user){
    paymentMessage.innerText="Data not saved âŒ (User not authenticated)";
    paymentMessage.style.color="#ff5252";
    return;
  }

  submitBtn.disabled=true;
  submitBtn.innerText="Saving...";

  try{

    await addDoc(collection(db,"customerPayments"),{
      customerName:document.getElementById("customerName").value.trim(),
      executiveName:document.getElementById("executiveName").value.trim(),
      totalAmount:Number(document.getElementById("totalAmount").value),
      status:"Pending",
      isLocked:true,
      payments:[],
      createdBy:user.uid,
      createdAt:serverTimestamp()
    });

    paymentMessage.innerText="Data saved successfully âœ”";
    paymentMessage.style.color="#00e676";
    paymentForm.reset();
    loadRecords();

  }catch(error){
    console.error(error);
    paymentMessage.innerText="Data not saved âŒ";
    paymentMessage.style.color="#ff5252";
  }

  submitBtn.disabled=false;
  submitBtn.innerText="Submit";
});

/* ==============================
   LOAD RECORDS
============================== */
async function loadRecords(){
  const user=auth.currentUser;
  if(!user) return;

  const q=query(collection(db,"customerPayments"),
    where("createdBy","==",user.uid)
  );

  const snapshot=await getDocs(q);
  const table=document.getElementById("recordsTable");
  table.innerHTML="";

  snapshot.forEach(docSnap=>{
    const data=docSnap.data();
    const payments=data.payments||[];
    const totalPaid=payments.reduce((sum,p)=>sum+p.amount,0);

    table.innerHTML+=`
    <tr>
      <td>${data.customerName}</td>
      <td>${data.executiveName}</td>
      <td>â‚¹${data.totalAmount}</td>
      <td>â‚¹${totalPaid}</td>
      <td>${data.status}</td>
      <td>${data.isLocked ? "Locked" : "Editable"}</td>
    </tr>`;
  });
}

/* ==============================
   LOGOUT
============================== */
window.logoutUser = async function(){
  await auth.signOut();
  window.location.href="index.html";
};
</script>

</body>
</html>
