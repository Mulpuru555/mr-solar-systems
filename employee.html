<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Employee Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
margin:0;
font-family:'Montserrat',sans-serif;
background:#0f0f0f;
color:white;
}

.header{
background:#000;
padding:15px 30px;
display:flex;
justify-content:space-between;
align-items:center;
box-shadow:0 4px 10px rgba(0,0,0,0.6);
}

.header h2{
color:#ff8c00;
margin:0;
}

.logout-btn{
background:#ff8c00;
border:none;
padding:8px 15px;
color:white;
border-radius:6px;
cursor:pointer;
transition:0.3s;
}
.logout-btn:hover{
background:#ff5e00;
transform:scale(1.05);
}

.dashboard-container{
padding:40px;
max-width:1200px;
margin:auto;
}

.section-title{
margin-bottom:15px;
color:#ff8c00;
font-weight:600;
}

/* Attendance Box */
.attendance-box{
background:#1a1a1a;
padding:30px;
border-radius:15px;
box-shadow:0 0 20px rgba(255,140,0,0.15);
margin-bottom:40px;
text-align:center;
}

.attendance-btn{
margin-top:20px;
padding:12px 25px;
background:linear-gradient(45deg,#ff8c00,#ff5e00);
border:none;
color:white;
border-radius:8px;
cursor:pointer;
font-weight:600;
transition:0.3s;
}
.attendance-btn:hover{
transform:scale(1.05);
}
.attendance-btn:disabled{
background:gray;
cursor:not-allowed;
}

.status-message{
margin-top:15px;
font-weight:600;
}

.distance-box{
margin-top:15px;
font-weight:bold;
}

.green{color:#00e676;}
.red{color:#ff5252;}

/* ERP Box */
.payment-box{
background:#1a1a1a;
padding:30px;
border-radius:15px;
box-shadow:0 0 20px rgba(255,140,0,0.15);
margin-bottom:40px;
}

.payment-box input{
padding:12px;
width:260px;
border-radius:8px;
border:none;
margin-bottom:15px;
background:#222;
color:white;
}

.payment-btn{
padding:12px 25px;
background:linear-gradient(45deg,#ff8c00,#ff5e00);
border:none;
color:white;
border-radius:8px;
cursor:pointer;
font-weight:600;
transition:0.3s;
}
.payment-btn:hover{
transform:scale(1.05);
}

/* Table */
table{
width:100%;
border-collapse:collapse;
margin-top:20px;
background:#1a1a1a;
border-radius:15px;
overflow:hidden;
}

th{
background:#222;
color:#ff8c00;
padding:12px;
}

td{
padding:12px;
border-bottom:1px solid #333;
text-align:center;
}

tr:hover{
background:#222;
}
</style>
</head>

<body>

<div class="header">
<h2>M.R Solar Systems Employee Portal</h2>
<button class="logout-btn" onclick="logoutUser()">Logout</button>
</div>

<div class="dashboard-container">

<h2 class="section-title">Attendance</h2>

<div class="attendance-box">
<div id="distanceDisplay" class="distance-box">Checking location...</div>
<div id="countdownBox" style="margin-bottom:15px;font-weight:600;">Loading countdown...</div>

<button id="attendanceBtn" class="attendance-btn" onclick="markAttendance()" disabled>
Mark Attendance
</button>

<div id="attendanceStatus" class="status-message"></div>
</div>

<h2 class="section-title">Add Customer (ERP)</h2>

<div class="payment-box">

<form id="paymentForm">
<input type="text" id="customerName" placeholder="Customer Name" required><br>
<input type="text" id="executiveName" placeholder="Executive Name" required><br>
<input type="number" id="totalAmount" placeholder="Total Amount" required><br>
<button type="submit" class="payment-btn">Submit</button>
</form>

<div id="paymentMessage" class="status-message"></div>

</div>

<h2 class="section-title">My Registrations</h2>

<table>
<thead>
<tr>
<th>Customer</th>
<th>Executive</th>
<th>Total</th>
<th>Paid</th>
<th>Status</th>
<th>Lock</th>
</tr>
</thead>
<tbody id="recordsTable"></tbody>
</table>

</div>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { addDoc, collection, serverTimestamp, query, where, getDocs, doc, getDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* ================= AUTH INIT ================= */

onAuthStateChanged(auth,(user)=>{
  if(user){
    startCountdown();
    startLocationTracking();
    loadRecords();
  }
});

/* ================= ERP SAFE SAVE ================= */

const paymentForm = document.getElementById("paymentForm");
const paymentMessage = document.getElementById("paymentMessage");
const submitBtn = paymentForm.querySelector("button");

paymentForm.addEventListener("submit", async (e)=>{
  e.preventDefault();

  paymentMessage.innerText="";
  const user = auth.currentUser;

  if(!user){
    paymentMessage.innerText="Data not saved ❌ (User not authenticated)";
    paymentMessage.style.color="#ff5252";
    return;
  }

  submitBtn.disabled=true;
  submitBtn.innerText="Saving...";

  try{

    await addDoc(collection(db,"customerPayments"),{
      customerName: document.getElementById("customerName").value.trim(),
      executiveName: document.getElementById("executiveName").value.trim(),
      totalAmount: Number(document.getElementById("totalAmount").value),
      status:"Pending",
      isLocked:true,
      payments:[],
      createdBy:user.uid,
      createdAt:serverTimestamp()
    });

    paymentMessage.innerText="Data saved successfully ✔";
    paymentMessage.style.color="#00e676";
    paymentForm.reset();
    loadRecords();

  }catch(error){

    console.error("Customer save error:",error);
    paymentMessage.innerText="Data not saved ❌";
    paymentMessage.style.color="#ff5252";

  }

  submitBtn.disabled=false;
  submitBtn.innerText="Submit";
});

/* ================= LOAD RECORDS ================= */

async function loadRecords(){
  const user = auth.currentUser;
  if(!user) return;

  const q = query(collection(db,"customerPayments"),
    where("createdBy","==",user.uid)
  );

  const snapshot = await getDocs(q);
  const table = document.getElementById("recordsTable");
  table.innerHTML="";

  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const payments = data.payments || [];
    const totalPaid = payments.reduce((sum,p)=>sum+p.amount,0);

    table.innerHTML+=`
    <tr>
      <td>${data.customerName}</td>
      <td>${data.executiveName}</td>
      <td>₹${data.totalAmount}</td>
      <td>₹${totalPaid}</td>
      <td>${data.status}</td>
      <td>${data.isLocked ? "Locked" : "Editable"}</td>
    </tr>`;
  });
}

/* ================= LOGOUT ================= */

window.logoutUser = async function(){
  await auth.signOut();
  window.location.href = "index.html";
};
</script>

</body>
</html>
