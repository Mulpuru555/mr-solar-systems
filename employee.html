<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Employee Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:'Montserrat',sans-serif;background:#111;color:white;}
.header{background:#000;padding:15px 30px;display:flex;justify-content:space-between;}
.header h2{color:#ff8c00;}
.logout-btn{background:#ff8c00;border:none;padding:8px 15px;color:white;border-radius:5px;}
.dashboard-container{padding:40px;text-align:center;}
.attendance-box{background:#1a1a1a;padding:30px;border-radius:10px;margin-top:30px;}
.attendance-btn{margin-top:20px;padding:12px 25px;background:linear-gradient(45deg,#ff8c00,#ff5e00);border:none;color:white;border-radius:6px;cursor:pointer;}
.attendance-btn:disabled{background:gray;cursor:not-allowed;}
.status-message{margin-top:15px;}
.distance-box{margin-top:15px;font-weight:bold;}
.green{color:#00e676;}
.red{color:#ff5252;}
.payment-box{background:#1a1a1a;padding:30px;border-radius:10px;margin-top:40px;}
.payment-box input{padding:10px;width:250px;border-radius:5px;border:none;margin-bottom:10px;}
.payment-btn{margin-top:10px;padding:12px 25px;background:linear-gradient(45deg,#ff8c00,#ff5e00);border:none;color:white;border-radius:6px;cursor:pointer;}
table{color:white;}
th,td{padding:8px;}
button{cursor:pointer;}
</style>
</head>

<body>

<div class="header">
<h2>M.R Solar Systems Employee Portal</h2>
<button class="logout-btn" onclick="logoutUser()">Logout</button>
</div>

<div class="dashboard-container">
<h1>Attendance</h1>

<div class="attendance-box">
<div id="distanceDisplay" class="distance-box">Checking location...</div>
<div id="countdownBox" style="margin-bottom:15px;font-weight:600;">ðŸ•’ Loading countdown...</div>
<button id="attendanceBtn" class="attendance-btn" onclick="markAttendance()">Mark Attendance</button>
<div id="attendanceStatus" class="status-message"></div>
</div>

<!-- ERP CUSTOMER SECTION -->
<div class="payment-box">
<h1>Add Customer (ERP)</h1>

<form id="paymentForm">
<input type="text" id="customerName" placeholder="Customer Name" required><br>
<input type="text" id="executiveName" placeholder="Executive Name" required><br>
<input type="number" id="totalAmount" placeholder="Total Amount" required><br>
<button type="submit" class="payment-btn">Submit</button>
</form>

<div id="paymentMessage" class="status-message"></div>
</div>

<hr style="margin:40px 0;">

<h1>My Registrations</h1>

<table style="width:100%; margin-top:20px; border-collapse:collapse;" border="1">
<thead>
<tr>
<th>Customer</th>
<th>Executive</th>
<th>Total</th>
<th>Paid</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="recordsTable"></tbody>
</table>

</div>

<script type="module">
import { checkSession } from "./auth.js";
checkSession("employee");
</script>

<script type="module">
import { auth, db } from "./firebase-config.js";
import { addDoc, collection, serverTimestamp, query, where, getDocs, doc, updateDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* ===== ERP CUSTOMER SUBMIT ===== */
const paymentForm = document.getElementById("paymentForm");
const paymentMessage = document.getElementById("paymentMessage");

paymentForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  try{
    await addDoc(collection(db,"customerPayments"),{
      customerName: document.getElementById("customerName").value,
      executiveName: document.getElementById("executiveName").value,
      totalAmount: Number(document.getElementById("totalAmount").value),
      status: "Pending",
      isLocked: true,
      payments: [],
      createdBy: auth.currentUser.uid,
      createdAt: serverTimestamp()
    });

    paymentMessage.innerText="âœ… Customer Added Successfully & Locked.";
    paymentForm.reset();
    loadRecords();

  }catch(error){
    paymentMessage.innerText="âŒ "+error.message;
  }
});

/* ===== LOAD CUSTOMER RECORDS ===== */
async function loadRecords() {
  const user = auth.currentUser;
  if (!user) return;

  const q = query(collection(db,"customerPayments"),
    where("createdBy","==",user.uid)
  );

  const snapshot = await getDocs(q);
  const table = document.getElementById("recordsTable");
  table.innerHTML = "";

  snapshot.forEach((docSnap)=>{
    const data = docSnap.data();

    const payments = data.payments || [];
    const totalPaid = payments.reduce((sum,p)=>sum + p.amount,0);
    const balance = data.totalAmount - totalPaid;

    table.innerHTML += `
      <tr>
        <td>${data.customerName}</td>
        <td>${data.executiveName}</td>
        <td>â‚¹${data.totalAmount}</td>
        <td>â‚¹${totalPaid}</td>
        <td>${data.status}</td>
        <td>
          ${data.isLocked ? 
            '<button disabled style="background:gray;">Locked</button>' :
            `<button onclick="editRecord('${docSnap.id}')">Edit</button>`
          }
        </td>
      </tr>
    `;
  });
}

/* ===== EDIT (Only if Admin Unlocks) ===== */
window.editRecord = async function(id){
  const newName = prompt("Customer Name:");
  const newExec = prompt("Executive Name:");

  if(!newName || !newExec) return;

  await updateDoc(doc(db,"customerPayments",id),{
    customerName:newName,
    executiveName:newExec
  });

  loadRecords();
};

onAuthStateChanged(auth,()=>{ loadRecords(); });

</script>

<script type="module" src="auth.js"></script>

</body>
</html>
